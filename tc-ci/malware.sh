#!/usr/bin/env bash

set -e 
set -x 

CWD=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
cd $CWD/..

ARTIFACTS_DIR="./artifacts"  # Directory to store the reports
mkdir -p "${ARTIFACTS_DIR}"   # Create artifacts directory if it doesn't exist


export VERSION=${VERSION:-m_$(git rev-parse --short HEAD)}
DOCKER_IMAGE=${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/opswat/mdcl-menlo:${ENVIRONMENT}-$VERSION

REPORT_FILE="/var/log/clamav_scan_report.txt"

echo "##teamcity[progressMessage 'Processing malware scan']"
echo "Using Docker image: $DOCKER_IMAGE"

echo "##teamcity[blockOpened name='ECR Login']"
cd ./kubernetes
./deploy.aws.sh ecr_login
cd ..
echo "##teamcity[blockClosed name='ECR Login']"

echo "##teamcity[blockOpened name='Pull Image']"
echo "Pulling Docker image from ECR..."
if ! docker pull "$DOCKER_IMAGE"; then
    echo "ERROR: Failed to pull Docker image ${DOCKER_IMAGE}."
    echo "This may indicate the image hasn't been built yet or doesn't exist in ECR."
    exit 1
fi
echo "Successfully pulled Docker image ${DOCKER_IMAGE}"
echo "##teamcity[blockClosed name='Pull Image']"

# Build the scan image using the already-built Docker image as base
echo "##teamcity[blockOpened name='Build Scan Image']"
echo "Building ClamAV scan image..."
docker build --build-arg IMAGE="${DOCKER_IMAGE}" -f tc-ci/Dockerfile-menlo -t menlo-clamav:latest .
echo "##teamcity[blockClosed name='Build Scan Image']"

# Run ClamAV scan
echo "##teamcity[blockOpened name='Run ClamAV Scan']"
echo "Running Docker container for ClamAV scan..."

CONTAINER_NAME="temp_menlo_clamav"
if [[ $(docker ps -aq -f name="${CONTAINER_NAME}") ]]; then
    echo "Removing existing container ${CONTAINER_NAME}..."
    docker rm -f "${CONTAINER_NAME}"
fi

CONTAINER_ID=$(docker run -d --name "${CONTAINER_NAME}" menlo-clamav:latest)
EXIT_CODE=$(docker wait "${CONTAINER_ID}")

if docker cp "${CONTAINER_ID}:${REPORT_FILE}" "${ARTIFACTS_DIR}/" 2>/dev/null; then
    echo "ClamAV report copied to ${ARTIFACTS_DIR}/clamav_scan_report.txt"
else
    echo "WARNING: Failed to copy scan report from container (exit code: ${EXIT_CODE})"
    echo "The scan may have failed before creating the report file."
fi

docker rm -f "${CONTAINER_ID}"
echo "##teamcity[blockClosed name='Run ClamAV Scan']"

echo "##teamcity[publishArtifacts '${ARTIFACTS_DIR} => .']"
echo "ClamAV scan completed. Report available in ${ARTIFACTS_DIR}/"

exit $EXIT_CODE

