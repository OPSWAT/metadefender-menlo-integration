image:
  name: 108895011981.dkr.ecr.us-west-2.amazonaws.com/aws-terragrunt:1.0.2-eks
  aws: 
    access-key: $AWS_ACCESS_KEY_ID_dev
    secret-key: $AWS_SECRET_ACCESS_KEY_dev

definitions:
  steps:
    - step: &build
        name: Build images
        services:
          - docker
        caches:
          - docker
        script:
          - |
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_dev
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_dev
            if [[ $BITBUCKET_BRANCH == "develop" ]]; then
              ENV="dev"
            elif [[ $BITBUCKET_BRANCH == "main" ]]; then
              ENV="prod"
            else ENV="test"
            export MENLO_ENV=$ENV
            fi
            cd kubernetes
            ./deploy.aws.sh build_image
            ./deploy.aws.sh ecr_login
            ./deploy.aws.sh push_image
    - step: &deploy
        name: Deploy to EKS
        deployment: test
        services:
          - docker
        caches:
          - docker
        script:
          - cd kubernetes
          - ./deploy.aws.sh configure_cluster
          - ./deploy.aws.sh view_resources

pipelines:
  custom:
    test:
      - step: *build
      - step: *deploy